package com.adenon.sp.statistics;

import javax.persistence.EntityManager;

import org.apache.log4j.Logger;

import com.adenon.sp.kernel.osgi.Services;
import com.adenon.sp.monitoring.counters.ICounter;
import com.adenon.sp.monitoring.counters.IMonitor;
import com.adenon.sp.monitoring.counters.IMonitoringService;
import com.adenon.sp.persistence.IJpaProvider;
import com.adenon.sp.persistence.SystemPool;


public class StatisticPersister implements Runnable {

    private static final Logger      logger = Logger.getLogger(StatisticPersister.class);
    private final StatisticsManager  manager;
    private final IMonitoringService monitoring;
    private final EntityManager      entityManager;


    public StatisticPersister(StatisticsManager manager,
                              Services services) {
        this.manager = manager;
        this.monitoring = services.getService(IMonitoringService.class);
        this.entityManager = services.getService(IJpaProvider.class).entityManager(SystemPool.STATS);
    }

    @Override
    public void run() {
        try {
            for (MonitorStats stats : this.manager.getStats()) {
                if (!stats.takeSnapshot()) {
                    continue;
                }
                IMonitor monitor = this.monitoring.getMonitor(stats.getMonitorName());
                if (logger.isDebugEnabled()) {
                    logger.debug("[StatisticsManager][getStats] : Taking statistics for " + monitor + " ..");
                }
                stats.setSnapshotTime();
                for (ICounter counter : monitor.allCounters()) {
                    stats.addSnapshot(counter.takeSnapshot());
                }
                stats.saveSnapshots(this.entityManager);
            }
        } catch (Exception e) {
            logger.error("[StatisticPersister][run] : Error : " + e.getMessage(), e);
        }
    }


}
